---
import FloatingButton from "@/components/common/FloatingButton.astro";
---

<div id="back-to-top-wrapper" class="back-to-top-wrapper hide">
  <FloatingButton
    id="back-to-top-btn"
    icon="material-symbols:keyboard-arrow-up-rounded"
    ariaLabel="Back to Top"
    onclick="backToTop()"
    class=""
  />
  <svg class="progress-ring" viewBox="0 0 120 120">
    <circle cx="60" cy="60" r="40" class="progress-ring-bg"></circle>
    <circle
      cx="60"
      cy="60"
      r="40"
      class="progress-ring-circle"
      style="--progress: 0%"
    ></circle>
  </svg>
</div>

<script is:raw is:inline>
  function backToTop() {
    // ç›´æ¥ä½¿ç”¨åŸç”Ÿæ»šåŠ¨ï¼Œé¿å…OverlayScrollbarså†²çª
    window.scroll({ top: 0, behavior: "smooth" });
  }

  // ä½¿ç”¨ IIFE ä½œç”¨åŸŸï¼Œé¿å…å†…éƒ¨å‡½æ•°æ±¡æŸ“å…¨å±€å‘½åç©ºé—´
  (() => {
    function calculateScrollProgress() {
      const doc = document.documentElement;
      // ä¼˜å…ˆä½¿ç”¨ç°ä»£æµè§ˆå™¨æ ‡å‡†çš„ scrollY
      const scrollTop = window.scrollY || doc.scrollTop;
      const docHeight = doc.scrollHeight - window.innerHeight;
      return docHeight > 0 ? Math.min((scrollTop / docHeight) * 100, 100) : 0;
    }

    // å“åº”å¼è¿”å›é¡¶éƒ¨æŒ‰é’®ç®¡ç†å™¨
    if (typeof window.BackToTopManager === "undefined") {
      window.BackToTopManager = class BackToTopManager {
        constructor() {
          this.wrapper = document.getElementById("back-to-top-wrapper");
          this.progressRing = document.querySelector(".progress-ring-circle");
          this.ticking = false; // ç”¨äº requestAnimationFrame èŠ‚æµæ§åˆ¶
          this.init();
        }

        init() {
          if (!this.wrapper) return;
          this.setupScrollListener();
          // åˆå§‹åŒ–æ—¶ä¸»åŠ¨åŒæ­¥ä¸€æ¬¡çŠ¶æ€ï¼Œé˜²æ­¢é¡µé¢ä¸­é€”åˆ·æ–°æ—¶æŒ‰é’®çŠ¶æ€é”™è¯¯
          this.updateVisibility();
        }

        updateVisibility = () => {
          const scrollTop = window.scrollY || document.documentElement.scrollTop;
          const scrollPercent = calculateScrollProgress();

          // å½“æ»šåŠ¨è¶…è¿‡200pxæ—¶æ˜¾ç¤ºæŒ‰é’®
          if (scrollTop > 200) {
            this.wrapper.classList.remove("hide");
          } else {
            this.wrapper.classList.add("hide");
          }

          // æ›´æ–°è¿›åº¦æ¡
          if (this.progressRing) {
            this.progressRing.style.setProperty("--progress", scrollPercent + "%");
          }
          
          this.ticking = false; // æ›´æ–°å®Œæ¯•ï¼Œé‡Šæ”¾é”
        };

        setupScrollListener() {
          window.addEventListener("scroll", () => {
            if (!this.ticking) {
              window.requestAnimationFrame(this.updateVisibility);
              this.ticking = true;
            }
          }, { passive: true });
        }
      };
    }

    // æ¸…ç†äº†å†—ä½™çš„åˆå§‹åŒ–é€»è¾‘ï¼Œç¡®ä¿åªå®ä¾‹åŒ–ä¸€æ¬¡
    const initManager = () => new window.BackToTopManager();
    
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initManager);
    } else {
      initManager();
    }
  })();
</script>

<style is:global>
  #back-to-top-wrapper {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 1;
    pointer-events: auto;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    
    /* ä½¿ç”¨ clamp() æ›¿ä»£åŸæœ‰çš„å¤šä¸ªåª’ä½“æŸ¥è¯¢ï¼Œå®ç°å°ºå¯¸çš„æµä½“ç¼©æ”¾ */
    width: clamp(1.75rem, 0.143rem + 8.036vw, 4rem);
    height: clamp(1.75rem, 0.143rem + 8.036vw, 4rem);
  }

  #back-to-top-wrapper.hide {
    transform: scale(0.5);
    opacity: 0;
    pointer-events: none;
    height: 0 !important;
    width: 0 !important;
    margin: 0 !important;
    border-width: 0 !important;
    padding: 0 !important;
  }

  #back-to-top-wrapper #back-to-top-btn {
    width: 100%;
    height: 100%;
  }

  /* åœ†å½¢è¿›åº¦æ¡æ ·å¼ */
  .progress-ring {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
    pointer-events: none;
  }

  .progress-ring-bg {
    fill: none;
    stroke: rgba(0, 0, 0, 0.08);
    /* é…åˆå®¹å™¨çš„æµä½“ç¼©æ”¾ï¼Œä¿æŒè¿›åº¦æ¡èƒŒæ™¯çš„ç²—ç»†æ¯”ä¾‹ */
    stroke-width: clamp(1.5px, -0.285px + 0.558vw, 4px);
  }

  .progress-ring-circle {
    fill: none;
    stroke: var(--primary);
    stroke-linecap: round;
    stroke-dasharray: 251.33;
    /* 2 * Ï€ * 40 */
    stroke-dashoffset: calc(251.33 * (1 - var(--progress, 0%) / 100%));
    transition: stroke-dashoffset 0.3s ease;
    opacity: 0.8;
    /* åŒæ ·åº”ç”¨æµä½“ç¼©æ”¾çš„çº¿å®½ */
    stroke-width: clamp(1.5px, -0.285px + 0.558vw, 4px);
  }

  /* æš—è‰²ä¸»é¢˜ */
  :global(.dark) .progress-ring-bg {
    stroke: rgba(255, 255, 255, 0.1);
  }

  :global(.dark) .progress-ring-circle {
    opacity: 0.9;
  }

  /* æ‰€æœ‰çš„ @media åª’ä½“æŸ¥è¯¢éƒ½å·²è¢«å®Œç¾æ›¿æ¢ï¼Œæ— éœ€ä¿ç•™ï¼ğŸ‰ */
</style>