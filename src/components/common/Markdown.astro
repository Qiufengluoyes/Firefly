---
// 只加载基础的等宽字体，减少加载时间
import path from 'node:path'
import { getImage } from 'astro:assets'
import { parseHTML } from 'linkedom'
import '@fontsource-variable/jetbrains-mono'
import '@fontsource-variable/jetbrains-mono/wght-italic.css'

interface Props {
	class: string;
    basePath?: string;
}
const { class: className, basePath = '/' } = Astro.props
/*
 * Normally, relative paths under the `src` directory are handled by Astro.
 * However, paths that the plugin couldn't process may appear here and require separate handling.
 */
const html = await Astro.slots.render('default')
const { document } = parseHTML(html)
await (async () => {
  // biome-ignore lint/suspicious/noExplicitAny: <explanation>
  const modules: Record<string, any> = import.meta.glob(
    '../../**/*.{jpeg,jpg,png,tiff,webp,gif,svg,avif}',
  )
  const re = /^(?![a-zA-Z]+:\/|\/)/
  for (const img of document.querySelectorAll('img')) {
    const src = img.getAttribute('src')
    if (!src || !re.test(src)) continue
    const normalizedPath = path
      .normalize(path.join('../../', basePath, src))
      .replaceAll('\\', '/')
    const moduleLoader = modules[normalizedPath]
    if (!moduleLoader) continue
    try {
      const module = await moduleLoader()
      const result = await getImage({ src: module.default })
      img.setAttribute('src', result.src)
    } catch (error) {
      console.warn(
        `Skipping image "${normalizedPath}" due to processing error:`,
        error,
      )
    }
  }
})()
---
<div data-pagefind-body class={`prose dark:prose-invert prose-base !max-w-none custom-md ${className}`}>
    <Fragment set:html={document.toString()} />
</div>

<script>
import { handleCodeCopy } from "@/utils/code-copy-utils";

document.addEventListener("click", function (e: MouseEvent) {
    const target = e.target as Element | null;
    if (target && target.classList.contains("copy-btn")) {
        handleCodeCopy(target);
    }
});
</script>
